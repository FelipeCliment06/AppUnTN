<div class="container">

  @if (document) {
    <!-- ========== CARD PRINCIPAL ========== -->
    <div class="doc-header">
      <div class="doc-header-top">
        <span class="badge-materia">{{ document.subject.replaceAll('_', ' ') }}</span>
        <div class="doc-rating-summary">
          <span class="stars-display">
            @for (i of estrellas; track $index) {
              <span class="star-sm" [class.filled]="i <= promedioRating">‚òÖ</span>
            }
          </span>
          <span class="rating-text">{{ promedioRating.toFixed(1) }} ({{ puntuaciones.length }})</span>
        </div>
      </div>

      <h2 class="doc-title">{{ document.title }}</h2>
      <p class="doc-description">{{ document.description }}</p>

      <div class="doc-meta">
        <div class="doc-meta-left">
          <a class="doc-author" [routerLink]="['/user-profile', document.authorUsername]">
            <span class="author-avatar">{{ document.authorUsername.charAt(0).toUpperCase() }}</span>
            {{ document.authorUsername }}
          </a>
          <span class="meta-separator">¬∑</span>
          <span class="doc-date">üìÖ {{ document.uploadDate }}</span>
        </div>
        <div class="doc-actions">
          <button class="btn-download" (click)="descargarResumen()">
            üì• Descargar
          </button>
          @if (isAdmin) {
            <button class="btn-danger-action" (click)="eliminarResumenCompleto()">
              üóëÔ∏è Eliminar
            </button>
          }
        </div>
      </div>
    </div>

    <!-- ========== CONTENIDO: 2 COLUMNAS ========== -->
    <div class="content-grid">

      <!-- COLUMNA IZQUIERDA: COMENTARIOS -->
      <div class="section-comments">
        <h3 class="section-title">üí¨ Comentarios ({{ comentarios.length }})</h3>

        @for (c of comentarios; track $index) {
          <div class="comment-card" [class.comment-destacado]="c.destacado">
            <div class="comment-header">
              <div class="comment-author-info">
                <span class="author-avatar small">{{ c.authorUsername.charAt(0).toUpperCase() }}</span>
                <strong>{{ c.authorUsername }}</strong>
                <span class="comment-date">{{ c.creationDate }}</span>
              </div>
              @if (c.authorUsername === username) {
                <button class="btn-delete" (click)="eliminarComentario(c.id)">‚úï</button>
              } @else if (isAdmin) {
                <button class="btn-moderate" (click)="eliminarComentario(c.id)">Moderar</button>
              }
            </div>
            <p class="comment-content">{{ c.content }}</p>
          </div>
        } @empty {
          <p class="empty-message">Todav√≠a no hay comentarios. ¬°S√© el primero!</p>
        }

        <!-- Nuevo comentario -->
        <div class="new-comment">
          <textarea
            class="comment-textarea"
            placeholder="Escrib√≠ tu comentario..."
            rows="3"
            [(ngModel)]="nuevoComentario"></textarea>
          <button class="btn-primary" (click)="enviarComentario()">Comentar</button>
        </div>
      </div>

      <!-- COLUMNA DERECHA: PUNTUACIONES -->
      <div class="section-ratings">
        <h3 class="section-title">‚≠ê Puntuaciones</h3>

        <!-- Tu puntuaci√≥n -->
        <div class="rate-box">
          <label class="rate-label">Tu puntuaci√≥n:</label>
          <div class="stars-input">
            @for (i of estrellas; track $index) {
              <span
                class="star"
                [class.selected]="puntuacionSeleccionada() >= i"
                (click)="selectStar(i)">‚òÖ</span>
            }
          </div>
          <button class="btn-primary btn-sm" (click)="enviarPuntuacion()">Enviar</button>
        </div>

        <!-- Lista de puntuaciones -->
        @for (p of puntuaciones; track $index) {
          <div class="rating-item">
            <div class="rating-item-left">
              <strong>{{ p.authorUsername }}</strong>
              <span class="stars-display small">
                @for (i of estrellas; track $index) {
                  <span class="star-sm" [class.filled]="i <= p.value">‚òÖ</span>
                }
              </span>
              @if (p.destacado) {
                <span class="badge-destacado">Destacado</span>
              }
            </div>
            @if (p.authorUsername === username) {
              <button class="btn-delete" (click)="eliminarPuntuacion(p.id)">‚úï</button>
            }
          </div>
        } @empty {
          <p class="empty-message">Sin puntuaciones a√∫n.</p>
        }
      </div>
    </div>
  }
</div>
